#!/usr/bin/env bash

#
# Run Altera Quartus programmer ASP
#   script is programming file (*.pof)
#   from Builds/<project>/<verion> directory (if there is only one *.pof),
#   or by name (first input parameter)
#

echo "+------------------------------------------------------------------------+"
echo "|  Quartus II Programmer ( ASP ) from Buils                              |"
echo "+------------------------------------------------------------------------+"

PATH2SCRIPT="$(cd "$(dirname "${BASH_SOURCE[0]}")" >/dev/null 2>&1 && pwd)"

if [ "$OS" = "Windows_NT" ]; then
    path="/d/Builds"
elif [ "`uname`" = Linux ]; then
    path="~/Builds"
fi

cd $path 2>/dev/null || {
    echo "Error! Can't change to necessary directory." >&2
    echo "There is not path '$path'"
    exit 1;
}

echo "List of project:"
cnt=1
for p in `ls -F | grep / | sed 's/\///g'`
do
    dir[$cnt]=$p
    echo " $cnt:  ${dir[$cnt]}"
    cnt=`expr $cnt + 1`
done

echo "To select project, enter num:"
read num junk

cd_check () {
    if [ ! -n "$1" ]; then
        echo "Error! You enter error number!"
        exit 1;
    fi
    cd "$1" || {
        echo "Error! Can't change to necessary directory." >&2
        echo "There is not path '`pwd`/$1'"
        exit 2;
    }
}

cd_check ${dir[$num]}
echo ""
echo "Current directory : '`pwd`"
echo "List of versions:"

if [ "$1" == "last" ]; then
    last=1
else
    last=0
fi

cnt=1
for p in `ls -F | grep / | sed 's/\///g'`
do
    ver[$cnt]=$p
    echo " $cnt:  ${ver[$cnt]}"
    cnt=`expr $cnt + 1`
done

if [ $last -eq 0 ]; then
    echo "To select version, enter num:"
    read num junk
else
    num=${#ver[*]}
fi

cd_check ${ver[$num]}

. "$PATH2SCRIPT"/fun_yesno

while :
do
    echo "-------------------------------------------------------"
    echo " NOTE: Current directory : '`pwd`"
    echo "-------------------------------------------------------"
    if fun_yesno "Would you like burnnig device" ; then
        q2_asp
        if [ "$?" -eq 0 ]; then
            exit 0;
        fi
    else
        echo "NOTE! Exit without burnnig!";
        exit 0;
    fi
done
