#!/usr/bin/env bash

#
# Run analysis project files by Altera Quartus in current directory
#

echo "+------------------------------------------------------------------------+"
echo "|  Quartus Script to Check Design File Syntax                            |"
echo "+------------------------------------------------------------------------+"

FILES_WITH_ERRORS=""

PATH2SCRIPT="$(cd "$(dirname "${BASH_SOURCE[0]}")" >/dev/null 2>&1 && pwd)"
. "$PATH2SCRIPT"/fun_yesno
. "$PATH2SCRIPT"/fun_q2_set_path

fun_q2_set_path

if [ ! "$1" ]
then
    if fun_yesno Do you really wish check all files?
    then
        for filename in `ls *.sv *.v`
        do
            # Perform a syntax check on the specified file
            $quartus_bin_dir/quartus_map fir_filter --analyze_file=$filename 1>/dev/null
            # If the exit code is non-zero, the file has a syntax error
            if [ $? -ne 0 ]
            then
                FILES_WITH_ERRORS="$FILES_WITH_ERRORS $filename"
            fi
        done
    else
        echo Exit without check!
        exit 2
    fi
else
    if [ ! -s $1 ]
    then
        echo Error! There are not file: $1!
        exit 3
    fi

    # Perform a syntax check on the specified file
    $quartus_bin_dir/quartus_map fir_filter --analyze_file=$1
    # If the exit code is non-zero, the file has a syntax error
    if [ $? -ne 0 ]
    then
        FILES_WITH_ERRORS="$FILES_WITH_ERRORS $1"
    fi
fi

if [ -z "$FILES_WITH_ERRORS" ]
then
    echo "All files passed the syntax check"
    exit 0
else
    echo "There were syntax errors in the following file(s):"
    echo
    echo $FILES_WITH_ERRORS
    echo
    exit 1
fi
