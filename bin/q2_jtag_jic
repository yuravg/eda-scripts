#!/usr/bin/env bash

#
# Run Altera Quartus programmer JTAG to load JIC-file from current directory
#
# Example usage:
# 1. script_name
# 2. script_name <file_name.jic>
#

echo "+------------------------------------------------------------------------+"
echo "|  Quartus II Programmer ( JTAG )                                        |"
echo "+------------------------------------------------------------------------+"

# if [[ "$fname" = *[[:space:]]* ]]; then
    # echo Error! Must be one \`*.jic\` file, there are: $fname
    # exit 1
# fi

PATH2SCRIPT="$(cd "$(dirname "${BASH_SOURCE[0]}")" >/dev/null 2>&1 && pwd)"

select_file ()
{
    cnt=1
    for p in `ls *.jic 2>/dev/null`; do
        jic_file[$cnt]=$p
        cnt=`expr $cnt + 1`
    done

    if [ ${#jic_file[@]} -gt 0 ]; then
        if [ ${#jic_file[@]} -eq 1 ]; then
            echo " ${jic_file[${1}]}"
        else
            echo " jic file(s):"
            for (( i=1; i<${#jic_file[@]}+1; i++ )); do
                echo "$i : ${jic_file[${i}]}"
            done
            echo "Select jic file :"
            read num_jic_file
        fi
    else
        echo "ERROR! Must be at least one *.jic file in dir: `pwd`"
        exit 2
    fi
    if [ -s "${jic_file[$num_jic_file]}" ]; then
        jic_file_name=${jic_file[$num_jic_file]}
    else
        jic_file_name=${jic_file[1]}
        if [ ${#jic_file[@]} -gt 1 ]; then
            echo "WARNING: will be open default jic file (can't find selected file)"
        fi
    fi

    . "$PATH2SCRIPT"/fun_yesno

    if [ ${#jic_file[@]} -gt 1 ]; then
        while :
        do
            if fun_yesno "Would you like load file: '$jic_file_name'" ; then
                break;
            else
                echo "NOTE! Exit without load!";
                exit 0;
            fi
        done
    fi
}

if [ -n "$1" ]; then
    if [ ! -s "$1" ]; then
        echo "ERROR! Can't find selected file: '$1'"
        exit 3
    fi
    jic_file_name=$1
else
    select_file
fi

f_time=$(date +%c -r $sof_file_name)
echo "File to Programming: '$jic_file_name'" $f_time

. "$PATH2SCRIPT"/fun_q2_set_path
fun_q2_set_path
$quartus_bin_dir/quartus_pgm -c USB-Blaster -m jtag -o pvbi\;$jic_file_name
